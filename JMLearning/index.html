<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>JMLearning</title>
    <link rel="stylesheet" href="./styles.css">
    <script type="module" src="./payment-div.js"></script>
    <script type="module" src="./background-art.js"></script>
    <script type="module" src="./stats.js"></script>
</head>
<body style="overflow-y:auto;">
    <div class="topbar">JMLearning</div>
    <div class="container" style="margin-top:calc(28px + 0.25em);">
        <h2>Joshua M. Tutoring Services:</h2>
        <payment-div amount="50.00" service-fee="2.00" description="1 hour tutoring"></payment-div>
        <payment-div amount="200.00" service-fee="6.00" description="4 hours tutoring (1 month)"></payment-div>
    </div>
    <footer>
        <small>JMLearning - Established 2025.</small>
    </footer>
    <script>
    // Suppress browser permissions policy warnings for cleaner console
    const originalConsoleWarn = console.warn;
    console.warn = function(...args) {
      const message = args.join(' ');
      if (message.includes('Permissions policy violation') || 
          message.includes('unload is not allowed') ||
          message.includes('geolocation is not allowed')) {
        return; // Suppress these specific warnings
      }
      originalConsoleWarn.apply(console, args);
    };
    
    let selectedPaymentDiv = null;
    let paypalConfig = null;
    
    // Load PayPal configuration from backend
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname.startsWith('10.0.0.');
    const apiBaseUrl = isLocal ? 'http://localhost:3000' : 'https://joshuamorvant.com';
    
    // Only show debug logs in development
    if (isLocal) {
      console.log('üîß Development mode detected');
      console.log('Detected hostname:', window.location.hostname);
      console.log('Using API URL:', apiBaseUrl);
    }
    
    fetch(`${apiBaseUrl}/api/config`)
      .then(res => res.json())
      .then(config => {
        if (isLocal) {
          console.log('‚úÖ PayPal config loaded:', config);
        }
        paypalConfig = config;
        window.paypalApiUrl = apiBaseUrl;
        const script = document.createElement('script');
        script.src = `https://www.paypal.com/sdk/js?client-id=${config.paypalClientId}&currency=USD`;
        script.onload = function() {
          window.dispatchEvent(new Event('paypal-sdk-ready'));
        };
        document.head.appendChild(script);
      })
      .catch(error => {
        console.error('‚ùå Failed to load PayPal configuration:', error);
        if (isLocal) {
          console.error('API URL attempted:', apiBaseUrl + '/api/config');
          console.error('Current hostname:', window.location.hostname);
        }
        
        // Show user-friendly error message
        const errorDiv = document.createElement('div');
        errorDiv.style = 'background:#ffe6e6;border:2px solid #ba0000;padding:24px 12px;margin:18px 0;font-size:1.2em;color:#ba0000;text-align:center;border-radius:12px;';
        errorDiv.innerHTML = `Payment system is currently unavailable.<br><small>Debug: Tried ${apiBaseUrl}/api/config</small><br>Please try again later or contact support.`;
        document.querySelector('.container').appendChild(errorDiv);
      });

    window.addEventListener('payment-div-selected', e => {
      document.querySelectorAll('payment-div').forEach(div => {
        div.setSelected(false);
      });
      e.detail.element.setSelected(true);
      selectedPaymentDiv = e.detail;
      if (isLocal) {
        console.log('üí∞ Selected service:', selectedPaymentDiv.description, '- $' + selectedPaymentDiv.amount);
      }
      renderBottomPayPalButton();
    });
    window.addEventListener('payment-div-unselected', e => {
      e.detail.element.setSelected(false);
      selectedPaymentDiv = null;
      renderBottomPayPalButton();
    });

    function renderBottomPayPalButton() {
      let btnContainer = document.getElementById('bottom-paypal-button');
      if (!btnContainer) {
        btnContainer = document.createElement('div');
        btnContainer.id = 'bottom-paypal-button';
        btnContainer.style = 'margin:32px auto 0 auto;max-width:480px;text-align:center;';
        const mainContainer = document.querySelector('.container');
        if (mainContainer) {
          mainContainer.appendChild(btnContainer);
        } else {
          document.body.appendChild(btnContainer);
        }
      }
      btnContainer.innerHTML = '';
      if (!selectedPaymentDiv || !window.paypal) return;
      let msg = document.getElementById('bottom-paypal-message');
      if (msg) msg.remove();
      window.paypal.Buttons({
        fundingSource: window.paypal.FUNDING.CARD,
        createOrder: async function(data, actions) {
          const amount = (parseFloat(selectedPaymentDiv.amount) + parseFloat(selectedPaymentDiv.serviceFee)).toFixed(2);
          const response = await fetch(window.paypalApiUrl + '/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount })
          });
          const order = await response.json();
          return order.id;
        },
        onClick: function() {
          window.dispatchEvent(new Event('paypal-button-clicked'));
        },
        onApprove: async function(data, actions) {
          const response = await fetch(window.paypalApiUrl + '/capture-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId: data.orderID })
          });
          const captureData = await response.json();
          const msgDiv = document.createElement('div');
          msgDiv.id = 'bottom-paypal-message';
          let amountText = '';
          try {
            const pu = captureData.purchase_units?.[0];
            const cap = pu?.payments?.captures?.[0];
            if (cap?.amount?.value) {
              amountText = `<div style='background:#e6f7ff;border:2px solid #0070ba;padding:24px 12px;margin:18px 0;font-size:2em;font-weight:bold;color:#0070ba;text-align:center;border-radius:12px;box-shadow:0 2px 8px #0070ba22;'>Payment of $${cap.amount.value} USD was successfully processed.</div>`;
            } else {
              amountText = `<div style='background:#ffe6e6;border:2px solid #ba0000;padding:24px 12px;margin:18px 0;font-size:1.5em;font-weight:bold;color:#ba0000;text-align:center;border-radius:12px;box-shadow:0 2px 8px #ba000022;'>Payment succeeded, but could not read amount from response.</div>`;
            }
          } catch (err) {
            amountText = `<div style='background:#ffe6e6;border:2px solid #ba0000;padding:24px 12px;margin:18px 0;font-size:1.5em;font-weight:bold;color:#ba0000;text-align:center;border-radius:12px;box-shadow:0 2px 8px #ba000022;'>Payment succeeded, but response format was unexpected.</div>`;
          }
          msgDiv.innerHTML = amountText;
          btnContainer.appendChild(msgDiv);
          // After payment is captured and confirmed:
          window.dispatchEvent(new Event('paypal-payment-approved'));
        },
        onError: function(err) {
          const msgDiv = document.createElement('div');
          msgDiv.id = 'bottom-paypal-message';
          msgDiv.textContent = 'Payment failed: ' + err;
          btnContainer.appendChild(msgDiv);
        }
      }).render(btnContainer);
      // Ensure 'Powered by PayPal' branding is visible
      if (!document.getElementById('paypal-branding')) {
        const branding = document.createElement('div');
        branding.id = 'paypal-branding';
        branding.style = 'margin-top:8px;text-align:center;';
        branding.innerHTML = '<img src="https://techtolia.com/PayPal/assets/images/powered_by_paypal.png" alt="Powered by PayPal" style="height:24px;background:transparent;">';
        btnContainer.appendChild(branding);
      }
    }
    window.addEventListener('paypal-sdk-ready', () => {
      if (selectedPaymentDiv) renderBottomPayPalButton();
    });
    </script>
</body>
</html>
