<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PayPal Store</title>
    <link rel="stylesheet" href="./styles.css">
    <script type="module" src="./payment-div.js"></script>
    <script type="module" src="./background-art.js"></script>
    <script type="module" src="./stats.js"></script>
</head>
<body>
    <div class="topbar">JMLearning</div>
    <div class="container" style="margin-top:calc(28px + 0.25em);">
        <h2>Joshua M. Tutoring Services:</h2>
        <payment-div amount="50.00" service-fee="2.00" description="1 hour tutoring"></payment-div>
        <payment-div amount="200.00" service-fee="2.00" description="4 hours tutoring (1 month)"></payment-div>
    </div>
    <footer>
        <small>JMLearning - Established 2025.</small>
    </footer>
    <script>
    let selectedPaymentDiv = null;
    let paypalConfig = null;
    // fetch('/api/config')
    //   .then(res => res.json())
    //   .then(config => {
    //     paypalConfig = config;
    //     window.paypalApiUrl = config.testing ? 'http://localhost:3000' : 'https://joshuamorvant.com';
    //     const script = document.createElement('script');
    //     script.src = `https://www.paypal.com/sdk/js?client-id=${config.paypalClientId}&currency=USD`;
    //     script.onload = function() {
    //       window.dispatchEvent(new Event('paypal-sdk-ready'));
    //     };
    //     document.head.appendChild(script);
    //   });

    // Manually set .env variables for testing
    paypalConfig = {
      testing: false,
      paypalClientId: 'AY9oYRC-YpMBFa8nJBSXcNNicaOt40-aSKJz_sJNO-_2_0eLbt9aya8_6POSsL11EX5a95LDC6TkBZLB',
      paypalApi: 'https://api-m.paypal.com',
      paypalTestAccount: {
        email: 'sb-yok3r46103766@personal.example.com',
        pass: '1U^xj!Mk',
        name: 'John Doe',
        card: '4032036087824189',
        exp: '09/2030',
        cvc: '000'
      }
    };
    window.paypalApiUrl = 'https://joshuamorvant.com';
    const script = document.createElement('script');
    script.src = `https://www.paypal.com/sdk/js?client-id=${paypalConfig.paypalClientId}&currency=USD`;
    script.onload = function() {
      window.dispatchEvent(new Event('paypal-sdk-ready'));
    };
    document.head.appendChild(script);

    window.addEventListener('payment-div-selected', e => {
      document.querySelectorAll('payment-div').forEach(div => {
        div.setSelected(false);
      });
      e.detail.element.setSelected(true);
      selectedPaymentDiv = e.detail;
      renderBottomPayPalButton();
    });
    window.addEventListener('payment-div-unselected', e => {
      e.detail.element.setSelected(false);
      selectedPaymentDiv = null;
      renderBottomPayPalButton();
    });

    function renderBottomPayPalButton() {
      let btnContainer = document.getElementById('bottom-paypal-button');
      if (!btnContainer) {
        btnContainer = document.createElement('div');
        btnContainer.id = 'bottom-paypal-button';
        btnContainer.style = 'margin:32px auto 0 auto;max-width:480px;text-align:center;';
        const mainContainer = document.querySelector('.container');
        if (mainContainer) {
          mainContainer.appendChild(btnContainer);
        } else {
          document.body.appendChild(btnContainer);
        }
      }
      btnContainer.innerHTML = '';
      if (!selectedPaymentDiv || !window.paypal) return;
      let msg = document.getElementById('bottom-paypal-message');
      if (msg) msg.remove();
      window.paypal.Buttons({
        fundingSource: window.paypal.FUNDING.CARD,
        createOrder: async function(data, actions) {
          const amount = (parseFloat(selectedPaymentDiv.amount) + parseFloat(selectedPaymentDiv.serviceFee)).toFixed(2);
          const response = await fetch(window.paypalApiUrl + '/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount })
          });
          const order = await response.json();
          return order.id;
        },
        onClick: function() {
          window.dispatchEvent(new Event('paypal-button-clicked'));
        },
        onApprove: async function(data, actions) {
          const response = await fetch(window.paypalApiUrl + '/capture-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId: data.orderID })
          });
          const captureData = await response.json();
          const msgDiv = document.createElement('div');
          msgDiv.id = 'bottom-paypal-message';
          msgDiv.innerHTML = `<div style='background:#e6f7ff;border:2px solid #0070ba;padding:24px 12px;margin:18px 0;font-size:2em;font-weight:bold;color:#0070ba;text-align:center;border-radius:12px;box-shadow:0 2px 8px #0070ba22;'><span style='font-size:2.5em;display:block;margin-bottom:10px;'>✔️</span>Payment of $${captureData.purchase_units[0].payments.captures[0].amount.value} USD was successfully processed.</div>`;
          btnContainer.appendChild(msgDiv);
          // After payment is captured and confirmed:
          window.dispatchEvent(new Event('paypal-payment-approved'));
        },
        onError: function(err) {
          const msgDiv = document.createElement('div');
          msgDiv.id = 'bottom-paypal-message';
          msgDiv.textContent = 'Payment failed: ' + err;
          btnContainer.appendChild(msgDiv);
        }
      }).render(btnContainer);
      // Ensure 'Powered by PayPal' branding is visible
      if (!document.getElementById('paypal-branding')) {
        const branding = document.createElement('div');
        branding.id = 'paypal-branding';
        branding.style = 'margin-top:8px;text-align:center;';
        branding.innerHTML = '<img src="https://www.paypalobjects.com/webstatic/icon/pp258.png" alt="Powered by PayPal" style="height:24px;background:transparent;">';
        btnContainer.appendChild(branding);
      }
    }
    window.addEventListener('paypal-sdk-ready', () => {
      if (selectedPaymentDiv) renderBottomPayPalButton();
    });
    </script>
</body>
</html>
